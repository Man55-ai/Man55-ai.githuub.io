<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Result - ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô ‡πÄ‡∏Ç‡∏ï 6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        .highlight-update { animation: pulse-yellow 1s ease-out; }
        @keyframes pulse-yellow { 0% { background-color: rgba(250, 204, 21, 0.5); } 100% { background-color: transparent; } }
        /* Modal Animation */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen font-sans">
    
    <div class="bg-slate-800 p-4 shadow-lg sticky top-0 z-10 border-b border-slate-700">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <h1 class="text-xl md:text-2xl font-bold text-yellow-400">üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á (‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô ‡πÄ‡∏Ç‡∏ï 6)</h1>
                <span class="text-xs text-slate-400 mt-1">(‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£)</span>
            </div>
            <div id="connectionStatus" class="flex items-center space-x-2 bg-slate-900 px-3 py-1 rounded-full border border-slate-700">
                <span class="w-2 h-2 bg-gray-500 rounded-full" id="statusDot"></span>
                <span class="text-xs font-bold tracking-wider text-gray-400" id="statusText">CONNECTING...</span>
            </div>
        </div>
    </div>
    <script>
    // 1. ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤ (Context Menu)
    document.addEventListener('contextmenu', event => event.preventDefault());

    // 2. ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ
    document.onkeydown = function(e) {
        // ‡∏Å‡∏±‡∏ô F12
        if (e.keyCode == 123) {
            return false;
        }
        // ‡∏Å‡∏±‡∏ô Ctrl+I (DevTools)
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
            return false;
        }
        // ‡∏Å‡∏±‡∏ô Ctrl+J (DevTools Console)
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
            return false;
        }
        // ‡∏Å‡∏±‡∏ô Ctrl+U (View Source)
        if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
            return false;
        }
        // ‡∏Å‡∏±‡∏ô Ctrl+S (Save)
        if (e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) {
            alert('‡∏´‡πâ‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ô‡∏µ‡πâ!'); // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            return false;
        }
    }
    </script>
    <div class="container mx-auto p-4 md:p-6 max-w-5xl">
        <div class="bg-slate-800 p-4 rounded-lg mb-6 shadow-md border border-slate-700">
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 items-center">
                <div class="text-sm text-gray-400 whitespace-nowrap">üîç ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</div>
                <select id="amphoeFilter" class="bg-slate-700 text-white p-2 rounded w-full md:w-auto flex-1 border border-slate-600 focus:border-yellow-400 outline-none" onchange="handleAmphoeChange()"></select>
                <select id="tambonFilter" class="hidden bg-slate-700 text-white p-2 rounded w-full md:w-auto flex-1 border border-slate-600 focus:border-yellow-400 outline-none" onchange="calculateResults()">
                    <option value="ALL">‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>
                </select>
            </div>
        </div>

        <div class="bg-slate-800 p-6 rounded-lg shadow-md mb-8 border border-slate-700">
            <h2 class="text-lg font-semibold mb-4 text-center text-gray-200">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</h2>
            <div class="h-64 md:h-80 relative w-full"><canvas id="mainChart"></canvas></div>
        </div>

        <div class="bg-slate-800 p-6 rounded-lg shadow-md border border-slate-700">
            <div class="flex justify-between items-end mb-6 border-b border-slate-700 pb-2">
                <h2 class="text-lg font-semibold text-gray-200">üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h2>
                <span class="text-xs text-gray-400 italic">*‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
                <span class="text-xs text-gray-500" id="lastUpdate">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
            </div>
            <div id="leaderboard" class="space-y-3">
                <div class="text-center py-10 text-gray-500 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-90" onclick="closeModal()"></div>
        
        <div class="modal-container bg-slate-800 w-11/12 md:max-w-3xl mx-auto rounded shadow-lg z-50 overflow-y-auto">
            
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b border-slate-600">
                    <div class="flex items-center gap-3" id="modalHeader">
                        </div>
                    <div class="modal-close cursor-pointer z-50" onclick="closeModal()">
                        <svg class="fill-current text-white" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </div>
                </div>

                <div class="my-5">
                    <h3 class="text-lg font-semibold text-gray-300 mb-2 text-center">üìç ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</h3>
                    <div class="h-64 relative w-full">
                        <canvas id="detailChart"></canvas>
                    </div>
                    
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-slate-700 p-4 rounded text-center">
                            <span class="text-gray-400 text-sm">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            <div class="text-3xl font-bold text-yellow-400" id="modalTotalScore">0</div>
                        </div>
                        <div class="bg-slate-700 p-4 rounded text-center">
                            <span class="text-gray-400 text-sm">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</span>
                            <div class="text-xl font-bold text-white" id="modalTopAmphoe">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const supabaseUrl = 'https://vtxkopsgdmxygdoqdjzz.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0eGtvcHNnZG14eWdkb3Fkanp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTA2NjYsImV4cCI6MjA4Mzg4NjY2Nn0.EabcmBvfAMLQLOt09GC_xxprZtLCJ-frsnfCf3__x5g'
        const db = window.supabase.createClient(supabaseUrl, supabaseKey)

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏£‡∏¥‡∏á
        const realLocationData = {
            "‡∏≠.‡∏†‡∏π‡∏ú‡∏≤‡∏°‡πà‡∏≤‡∏ô": {
                "‡∏ï.‡∏†‡∏π‡∏ú‡∏≤‡∏°‡πà‡∏≤‡∏ô": [ {m:1, n:"‡∏†‡∏π‡∏ú‡∏≤‡∏°‡πà‡∏≤‡∏ô"}, {m:2, n:"‡∏ã‡∏≥‡∏†‡∏π‡∏ó‡∏≠‡∏á‡πÉ‡∏ï‡πâ"}, {m:3, n:"‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏ô‡∏ô‡∏™‡∏π‡∏á"}, {m:4, n:"‡∏ó‡πà‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏∑‡∏≠"}, {m:5, n:"‡∏ô‡∏≤‡∏ô‡πâ‡∏≥‡∏ã‡∏≥"}, {m:6, n:"‡πÇ‡∏ô‡∏ô‡∏™‡∏ß‡πà‡∏≤‡∏á"}, {m:7, n:"‡∏ô‡∏≤‡∏ô‡πâ‡∏≥‡∏ã‡∏≥‡πÉ‡∏´‡∏°‡πà"}, {m:8, n:"‡∏´‡πâ‡∏ß‡∏¢‡∏ñ‡πâ‡∏≥‡πÄ‡∏ï‡πà‡∏≤"}, {m:9, n:"‡∏†‡∏π‡∏Å‡∏£‡∏∞‡πÅ‡∏ï"} ],
                "‡∏ï.‡πÇ‡∏ô‡∏ô‡∏Ñ‡∏≠‡∏°": [ {m:1, n:"‡πÇ‡∏ô‡∏ô‡∏Ñ‡∏≠‡∏°"}, {m:2, n:"‡πÄ‡∏ã‡∏¥‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠"}, {m:3, n:"‡πÄ‡∏ã‡∏¥‡∏ô‡πÉ‡∏ï‡πâ"}, {m:4, n:"‡∏ó‡πà‡∏≤‡∏Ç‡∏≤‡∏°"}, {m:5, n:"‡∏õ‡πà‡∏≤‡∏Å‡∏•‡πâ‡∏ß‡∏¢"}, {m:6, n:"‡∏õ‡πà‡∏≤‡∏Å‡∏•‡πâ‡∏ß‡∏¢ (‡πÅ‡∏¢‡∏Å‡πÉ‡∏´‡∏°‡πà)"}, {m:7, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏ô‡∏Å‡∏ó‡∏≤"}, {m:8, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏ó‡∏≠‡∏á"} ],
                "‡∏ï.‡∏ß‡∏±‡∏á‡∏™‡∏ß‡∏≤‡∏ö": [ {m:1, n:"‡∏ß‡∏±‡∏á‡∏™‡∏ß‡∏≤‡∏ö"}, {m:2, n:"‡∏ß‡∏±‡∏á‡∏ú‡∏≤‡∏î‡∏≥"}, {m:3, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏´‡πâ‡∏ß"}, {m:4, n:"‡∏ß‡∏±‡∏á‡∏°‡∏•"}, {m:5, n:"‡∏ß‡∏±‡∏á‡∏™‡∏ß‡∏≤‡∏ö"}, {m:6, n:"‡∏î‡∏á‡∏™‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏ô"}, {m:7, n:"‡∏ã‡∏≥‡∏ú‡∏±‡∏Å‡∏´‡∏ô‡∏≤‡∏°"}, {m:8, n:"‡∏ã‡∏≥‡∏°‡πà‡∏ß‡∏á"}, {m:9, n:"‡∏ß‡∏±‡∏á‡πÉ‡∏´‡∏°‡πà"}, {m:10, n:"‡πÇ‡∏ô‡∏ô‡πÄ‡∏ï‡∏≤‡πÄ‡∏´‡∏•‡πá‡∏Å"} ],
                "‡∏ï.‡∏ô‡∏≤‡∏ù‡∏≤‡∏¢": [ {m:1, n:"‡∏™‡∏∞‡πÅ‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠"}, {m:2, n:"‡∏ô‡∏≤‡∏ù‡∏≤‡∏¢‡πÉ‡∏ï‡πâ"}, {m:3, n:"‡∏™‡∏≠‡∏á‡∏Ñ‡∏≠‡∏ô"}, {m:4, n:"‡∏´‡πâ‡∏ß‡∏¢‡∏ã‡πâ‡∏≠"}, {m:5, n:"‡∏ô‡∏≤‡∏ù‡∏≤‡∏¢‡πÄ‡∏´‡∏ô‡∏∑‡∏≠"}, {m:6, n:"‡∏ã‡∏≥‡πÄ‡∏õ‡∏¥‡∏ö"} ],
                "‡∏ï.‡∏´‡πâ‡∏ß‡∏¢‡∏°‡πà‡∏ß‡∏á": [ {m:1, n:"‡∏ã‡∏≥‡∏†‡∏π‡∏ó‡∏≠‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠"}, {m:2, n:"‡∏ß‡∏±‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç"}, {m:3, n:"‡∏´‡πâ‡∏ß‡∏¢‡∏°‡πà‡∏ß‡∏á"}, {m:4, n:"‡πÇ‡∏ô‡∏ô‡∏™‡∏∞‡∏≠‡∏≤‡∏î"}, {m:5, n:"‡∏´‡πâ‡∏ß‡∏¢‡∏ã‡πâ‡∏≠"}, {m:6, n:"‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå"}, {m:7, n:"‡∏´‡πâ‡∏ß‡∏¢‡πÄ‡∏ï‡∏¢"}, {m:8, n:"‡∏ú‡∏≤‡∏ô‡πâ‡∏≥‡∏ó‡∏¥‡∏û‡∏¢‡πå"}, {m:9, n:"‡∏´‡πâ‡∏ß‡∏¢‡∏°‡πà‡∏ß‡∏á‡πÉ‡∏´‡∏°‡πà"} ]
            },
            "‡∏≠.‡∏ä‡∏∏‡∏°‡πÅ‡∏û": {
                "‡∏ï.‡∏ä‡∏∏‡∏°‡πÅ‡∏û (‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á)": [ {m:1, n:"‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏∏‡∏°‡πÅ‡∏û"}, {m:2, n:"‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏´‡∏±‡∏ß‡∏´‡∏ô‡∏≠‡∏á"}, {m:4, n:"‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡πÇ‡∏ô‡∏ô‡∏®‡∏¥‡∏•‡∏≤"}, {m:8, n:"‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç"}, {m:9, n:"‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏≤‡∏£‡∏µ"}, {m:10, n:"‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏Å‡∏∏‡∏î‡∏ä‡∏∏‡∏°‡πÅ‡∏û"}, {m:13, n:"‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ô‡∏≤‡πÇ‡∏û‡∏ò‡∏¥‡πå"}, {m:15, n:"‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏®‡∏£‡∏µ‡∏°‡∏á‡∏Ñ‡∏•"}, {m:16, n:"‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏´‡∏ô‡∏≠‡∏á‡∏ï‡∏≤‡πÑ‡∏Å‡πâ"}, {m:18, n:"‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ô‡∏Ñ‡∏£‡∏ä‡∏±‡∏¢"} ],
                "‡∏ï.‡∏ä‡∏∏‡∏°‡πÅ‡∏û (‡∏≠‡∏ö‡∏ï.)": [ {m:1, n:"‡πÅ‡∏´‡πà"}, {m:2, n:"‡∏°‡∏≤‡∏•‡∏≤"}, {m:3, n:"‡∏ô‡∏≤‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ"}, {m:4, n:"‡πÇ‡∏ô‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á"}, {m:5, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß"}, {m:6, n:"‡πÄ‡∏ä‡∏¥‡∏ç"}, {m:7, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏¥‡∏Å"}, {m:8, n:"‡πÅ‡∏Å‡πâ‡∏á‡∏¢‡∏≤‡∏ß"}, {m:9, n:"‡∏î‡∏≠‡∏ô‡∏´‡∏±‡∏ô"}, {m:10, n:"‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏≤‡∏£‡∏µ"}, {m:11, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß"} ],
                "‡∏ï.‡∏Ç‡∏±‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏á": [ {m:1, n:"‡∏ô‡∏≤‡∏™‡∏µ‡∏ô‡∏ß‡∏•"}, {m:2, n:"‡πÇ‡∏Ñ‡∏Å‡∏™‡∏π‡∏á"}, {m:3, n:"‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå"}, {m:4, n:"‡∏Ç‡∏≤‡∏°‡∏õ‡πâ‡∏≠‡∏°"}, {m:5, n:"‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Å"}, {m:6, n:"‡πÇ‡∏Ñ‡∏Å‡∏°‡πà‡∏ß‡∏á"}, {m:7, n:"‡πÇ‡∏Ñ‡∏Å‡∏°‡πà‡∏ß‡∏á"}, {m:8, n:"‡πÇ‡∏Ñ‡∏Å‡∏°‡πà‡∏ß‡∏á"}, {m:9, n:"‡πÇ‡∏ô‡∏ô‡∏®‡∏¥‡∏•‡∏≤"}, {m:10, n:"‡∏Ç‡∏≤‡∏°‡∏õ‡πâ‡∏≠‡∏°"}, {m:11, n:"‡πÇ‡∏õ‡πà‡∏á‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"}, {m:12, n:"‡∏Ç‡∏≤‡∏°‡∏õ‡πâ‡∏≠‡∏°"} ],
                "‡∏ï.‡∏ô‡∏≤‡∏´‡∏ô‡∏≠‡∏á‡∏ó‡∏∏‡πà‡∏°": [ {m:1, n:"‡∏ô‡∏≤‡∏´‡∏ô‡∏≠‡∏á‡∏ó‡∏∏‡πà‡∏°"}, {m:2, n:"‡πÇ‡∏ô‡∏ô‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏á"}, {m:3, n:"‡∏´‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡πÄ‡∏õ‡∏≤‡∏∞"}, {m:4, n:"‡∏ß‡∏±‡∏á‡∏¢‡∏≤‡∏ß‡πÉ‡∏´‡∏ç‡πà"}, {m:5, n:"‡πÇ‡∏ô‡∏ô‡∏ä‡∏≤‡∏î"}, {m:6, n:"‡πÇ‡∏ô‡∏ô‡πÇ‡∏Å"}, {m:7, n:"‡∏ß‡∏±‡∏á‡∏¢‡∏≤‡∏ß‡∏ô‡πâ‡∏≠‡∏¢"}, {m:8, n:"‡∏ô‡∏≤‡∏´‡∏ô‡∏≠‡∏á‡∏ó‡∏∏‡πà‡∏°"}, {m:9, n:"‡∏ô‡πâ‡∏≠‡∏¢‡∏û‡∏±‡∏í‡∏ô‡∏≤"}, {m:10, n:"‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß"}, {m:11, n:"‡∏ã‡∏≥‡∏ú‡∏±‡∏Å‡∏´‡∏ô‡∏≤‡∏°"}, {m:12, n:"‡∏ô‡πâ‡∏≠‡∏¢‡∏û‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå"}, {m:13, n:"‡∏ß‡∏±‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏≤"} ],
                "‡∏ï.‡πÇ‡∏ô‡∏ô‡∏´‡∏±‡∏ô": [ {m:1, n:"‡πÇ‡∏ô‡∏ô‡∏´‡∏±‡∏ô"}, {m:2, n:"‡πÇ‡∏ô‡∏ô‡∏ä‡∏±‡∏¢"}, {m:3, n:"‡∏£‡πà‡∏≠‡∏á‡πÅ‡∏ã‡∏á"}, {m:4, n:"‡πÇ‡∏ô‡∏ô‡∏ä‡∏≤‡∏ï‡∏¥"}, {m:5, n:"‡πÇ‡∏ô‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á"}, {m:6, n:"‡πÇ‡∏ô‡∏ô‡∏á‡∏≤‡∏°"}, {m:7, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏°‡πà‡∏ß‡∏á"}, {m:8, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≠‡∏á"}, {m:9, n:"‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏ô‡∏ô‡∏ä‡∏≤‡∏ï‡∏¥"}, {m:10, n:"‡πÇ‡∏ô‡∏ô‡∏´‡∏±‡∏ô‡πÉ‡∏ô"} ],
                "‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏î": [ {m:1, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏î"}, {m:2, n:"‡∏à‡∏≠‡∏°‡∏®‡∏£‡∏µ"}, {m:3, n:"‡πÇ‡∏Ñ‡∏Å‡∏á‡∏≤‡∏°"}, {m:4, n:"‡∏ò‡∏≤‡∏ï‡∏∏"}, {m:5, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏Å‡∏∏‡∏á"}, {m:6, n:"‡πÇ‡∏ô‡∏ô‡∏®‡∏¥‡∏•‡∏≤"}, {m:7, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ß‡πâ‡∏≤"}, {m:8, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ô‡∏≤‡∏°‡πÅ‡∏ó‡πà‡∏á"}, {m:9, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏î"}, {m:10, n:"‡πÇ‡∏ô‡∏ô‡∏£‡∏±‡∏á"} ],
                "‡∏ï.‡πÇ‡∏ô‡∏ô‡∏™‡∏∞‡∏≠‡∏≤‡∏î": [ {m:1, n:"‡πÇ‡∏ô‡∏ô‡∏™‡∏∞‡∏≠‡∏≤‡∏î"}, {m:2, n:"‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏î‡πÅ‡∏≠‡πà"}, {m:3, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß"}, {m:4, n:"‡πÇ‡∏ô‡∏ô‡∏•‡∏≤‡∏ô"}, {m:5, n:"‡πÅ‡∏™‡∏ô‡∏™‡∏∏‡∏Ç"}, {m:6, n:"‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏™‡∏∏‡∏Ç"}, {m:7, n:"‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô"}, {m:8, n:"‡πÇ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"}, {m:9, n:"‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û"} ],
                "‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏™‡∏≤‡πÄ‡∏•‡πâ‡∏≤": [ {m:1, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏™‡∏≤‡πÄ‡∏•‡πâ‡∏≤"}, {m:2, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÇ‡∏û‡∏á‡πÇ‡∏û‡∏î"}, {m:3, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏®‡∏≤‡∏•‡∏≤"}, {m:4, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏®‡∏≤‡∏•‡∏≤"}, {m:5, n:"‡∏™‡∏∏‡∏Ç‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå"}, {m:6, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ß‡πâ‡∏≤"}, {m:7, n:"‡∏´‡πâ‡∏ß‡∏¢‡πÅ‡∏™‡∏á"}, {m:8, n:"‡πÇ‡∏ô‡∏ô‡∏ï‡∏∏‡πà‡∏ô"}, {m:9, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏™‡∏≤‡πÄ‡∏•‡πâ‡∏≤"}, {m:10, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ß‡πâ‡∏≤"} ],
                "‡∏ï.‡πÇ‡∏ô‡∏ô‡∏≠‡∏∏‡∏î‡∏°": [ {m:1, n:"‡∏î‡∏≠‡∏ô"}, {m:2, n:"‡∏´‡∏≠‡∏¢"}, {m:3, n:"‡πÇ‡∏Ñ‡∏Å‡∏™‡∏π‡∏á"}, {m:4, n:"‡πÇ‡∏ô‡∏ô‡∏™‡∏ß‡πà‡∏≤‡∏á"}, {m:5, n:"‡∏ö‡∏±‡∏ß‡∏™‡∏¥‡∏°‡∏°‡∏≤"}, {m:6, n:"‡πÇ‡∏ô‡∏ô‡∏≠‡∏∏‡∏î‡∏°"}, {m:7, n:"‡πÇ‡∏ô‡∏ô‡∏≠‡∏∏‡∏î‡∏°"}, {m:8, n:"‡∏û‡∏á‡∏©‡πå‡∏ö‡∏±‡∏ß‡∏ö‡∏≤‡∏ô"}, {m:9, n:"‡∏´‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á"}, {m:10, n:"‡∏´‡∏≠‡∏¢"}, {m:11, n:"‡∏´‡∏≠‡∏¢"} ],
                "‡∏ï.‡∏ß‡∏±‡∏á‡∏´‡∏¥‡∏ô‡∏•‡∏≤‡∏î": [ {m:1, n:"‡∏ß‡∏±‡∏á‡∏´‡∏¥‡∏ô‡∏•‡∏≤‡∏î"}, {m:2, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏ó‡∏∏‡πà‡∏°"}, {m:3, n:"‡∏ô‡∏≤‡∏Ñ‡∏≥‡∏ô‡πâ‡∏≠‡∏¢"}, {m:4, n:"‡∏ù‡∏≤‡∏¢‡∏´‡∏¥‡∏ô"}, {m:5, n:"‡πÇ‡∏õ‡πà‡∏á‡πÅ‡∏´‡πâ‡∏á"}, {m:6, n:"‡πÇ‡∏™‡∏Å‡∏Å‡πâ‡∏≠‡∏á"}, {m:7, n:"‡πÇ‡∏™‡∏Å‡∏≠‡∏∏‡∏î‡∏°"}, {m:8, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÑ‡∏ú‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠"}, {m:9, n:"‡∏ô‡∏≤‡∏î‡∏µ"}, {m:10, n:"‡∏ß‡∏±‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç"}, {m:11, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏ó‡∏≠‡∏á"}, {m:12, n:"‡∏ß‡∏±‡∏á‡∏´‡∏¥‡∏ô‡∏•‡∏≤‡∏î‡∏û‡∏±‡∏í‡∏ô‡∏≤"} ],
                "‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡πÑ‡∏ú‡πà": [ {m:1, n:"‡∏Å‡∏∏‡∏î‡πÄ‡∏Ç‡πâ"}, {m:2, n:"‡πÇ‡∏ô‡∏ô‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏á"}, {m:3, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÑ‡∏ú‡πà"}, {m:4, n:"‡∏ß‡∏±‡∏á‡∏´‡∏π‡∏Å‡∏ß‡∏≤‡∏á"}, {m:5, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÑ‡∏ú‡πà‡πÉ‡∏ï‡πâ"}, {m:6, n:"‡∏´‡πâ‡∏ß‡∏¢‡∏ö‡∏á"}, {m:7, n:"‡πÇ‡∏ô‡∏ô‡∏™‡∏∞‡∏≠‡∏≤‡∏î"}, {m:8, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏Ç‡∏≤‡∏°"}, {m:9, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏Ç‡∏≤‡∏°"}, {m:10, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏ú‡∏∑‡∏≠"}, {m:11, n:"‡πÄ‡∏ó‡∏û‡∏ô‡∏Ñ‡∏£"}, {m:12, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏•‡πà‡∏°"}, {m:13, n:"‡∏™‡∏∏‡∏Ç‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå"}, {m:14, n:"‡∏ñ‡∏¥‡πà‡∏ô‡∏≠‡∏∏‡∏î‡∏°"}, {m:15, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÑ‡∏ú‡πà‡∏û‡∏±‡∏í‡∏ô‡∏≤"}, {m:16, n:"‡πÇ‡∏ô‡∏ô‡∏ó‡∏≠‡∏á"}, {m:17, n:"‡∏ß‡∏±‡∏á‡∏´‡∏π‡∏Å‡∏ß‡∏≤‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠"}, {m:18, n:"‡∏Å‡∏∏‡∏î‡πÄ‡∏Ç‡πâ‡πÉ‡∏´‡∏°‡πà"}, {m:19, n:"‡∏°‡∏µ‡∏ä‡∏±‡∏¢"} ],
                "‡∏ï.‡∏ô‡∏≤‡πÄ‡∏û‡∏µ‡∏¢‡∏á": [ {m:1, n:"‡∏ô‡∏≤‡πÄ‡∏û‡∏µ‡∏¢‡∏á"}, {m:2, n:"‡πÇ‡∏ô‡∏ô‡∏•‡∏≤‡∏ô"}, {m:3, n:"‡πÇ‡∏ô‡∏ô‡∏™‡∏≤‡∏ß‡πÄ‡∏≠‡πâ"}, {m:4, n:"‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏î‡πÅ‡∏≠‡πà"}, {m:5, n:"‡πÇ‡∏ô‡∏ô‡πÇ‡∏û‡∏ò‡∏¥‡πå"}, {m:6, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÑ‡∏Æ"}, {m:7, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏ú‡∏∑‡∏≠"}, {m:8, n:"‡∏Å‡∏∏‡∏î‡∏ä‡∏∏‡∏°‡πÅ‡∏™‡∏á"}, {m:9, n:"‡∏ô‡∏≤‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà"}, {m:10, n:"‡πÇ‡∏ô‡∏ô‡∏•‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà"}, {m:11, n:"‡πÇ‡∏ô‡∏ô‡∏™‡∏≤‡∏ß‡πÄ‡∏≠‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤"}, {m:12, n:"‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏î‡πÅ‡∏≠‡πà‡∏û‡∏±‡∏í‡∏ô‡∏≤"}, {m:13, n:"‡πÇ‡∏ô‡∏ô‡πÇ‡∏û‡∏ò‡∏¥‡πå‡∏ó‡∏≠‡∏á"}, {m:14, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÑ‡∏Æ‡∏û‡∏±‡∏í‡∏ô‡∏≤"}, {m:15, n:"‡∏ô‡∏≤‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠"} ],
                "‡∏ï.‡πÑ‡∏ä‡∏¢‡∏™‡∏≠": [ {m:1, n:"‡πÑ‡∏ä‡∏¢‡∏™‡∏≠"}, {m:2, n:"‡πÑ‡∏ä‡∏¢‡∏™‡∏≠"}, {m:3, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏ï‡∏≤‡πÑ‡∏Å‡πâ"}, {m:4, n:"‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏∑‡πà‡∏≠"}, {m:5, n:"‡πÇ‡∏ô‡∏ô‡∏™‡∏≥‡∏£‡∏≤‡∏ç"}, {m:6, n:"‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏∑‡πà‡∏≠"}, {m:7, n:"‡∏®‡∏£‡∏µ‡πÄ‡∏ä‡∏¥‡∏ç"}, {m:8, n:"‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå"}, {m:9, n:"‡πÇ‡∏ô‡∏ô‡∏™‡∏ß‡πà‡∏≤‡∏á"}, {m:10, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÑ‡∏Æ"} ]
            },
            "‡∏≠.‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π": {
                "‡∏ï.‡∏ô‡∏≤‡∏à‡∏≤‡∏ô": [ {m:1, n:"‡∏ô‡∏≤‡∏à‡∏≤‡∏ô"}, {m:2, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÑ‡∏Æ"}, {m:3, n:"‡πÇ‡∏ô‡∏ô‡∏ß‡πà‡∏≤‡∏ô‡πÑ‡∏ü"}, {m:4, n:"‡∏™‡∏µ‡πà‡πÅ‡∏¢‡∏Å"}, {m:5, n:"‡πÇ‡∏ô‡∏ô‡∏™‡∏≥‡∏£‡∏≤‡∏ç"}, {m:6, n:"‡∏ß‡∏±‡∏á‡πÇ‡∏û‡∏ô"}, {m:7, n:"‡∏õ‡∏≤‡∏Å‡∏á‡πà‡∏≤‡∏°"}, {m:8, n:"‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏™‡∏á"}, {m:9, n:"‡∏ó‡πà‡∏≤‡∏ä‡πâ‡∏≤‡∏á"}, {m:10, n:"‡∏ß‡∏±‡∏á‡∏Ç‡∏≠‡∏ô‡∏¢‡∏°"}, {m:11, n:"‡∏ô‡∏≤‡πÄ‡∏à‡∏£‡∏¥‡∏ç"}, {m:12, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ç‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß"}, {m:13, n:"‡πÇ‡∏ô‡∏ô‡∏ó‡∏±‡∏ô"}, {m:14, n:"‡∏ô‡∏≤‡∏á‡∏≤‡∏°"}, {m:15, n:"‡πÇ‡∏ô‡∏ô‡∏´‡∏±‡∏ß‡∏ô‡∏≤"} ],
                "‡∏ï.‡∏ã‡∏≥‡∏¢‡∏≤‡∏á": [ {m:1, n:"‡∏ã‡∏≥‡∏¢‡∏≤‡∏á"}, {m:2, n:"‡∏™‡∏≤‡∏£‡∏à‡∏≠‡∏î"}, {m:3, n:"‡∏£‡πà‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á"}, {m:4, n:"‡∏´‡∏ô‡∏≠‡∏á‡∏Ç‡∏µ‡πâ‡∏Ñ‡∏ß‡∏≤‡∏¢"}, {m:5, n:"‡∏ï‡∏≤‡∏î"}, {m:6, n:"‡∏ã‡∏≥‡∏¢‡∏≤‡∏á"} ]
            }
        };

        let candidates = [], allVotes = [], myChart = null, detailChart = null;

        window.onload = async () => {
            initFilters();
            await loadInitialData();
            subscribeRealtime();
        };

        function initFilters() {
            const select = document.getElementById('amphoeFilter');
            select.innerHTML = `<option value="ALL">üìç ‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>`;
            Object.keys(realLocationData).forEach(a => {
                select.innerHTML += `<option value="${a}">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ${a}</option>`;
            });
        }

        function handleAmphoeChange() {
            const amphoe = document.getElementById('amphoeFilter').value;
            const tambonSelect = document.getElementById('tambonFilter');
            
            if(amphoe === 'ALL') {
                tambonSelect.classList.add('hidden');
                tambonSelect.value = 'ALL';
            } else {
                tambonSelect.innerHTML = `<option value="ALL">‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏•‡πÉ‡∏ô ${amphoe}</option>`;
                Object.keys(realLocationData[amphoe]).forEach(t => {
                    tambonSelect.innerHTML += `<option value="${t}">${t}</option>`;
                });
                tambonSelect.classList.remove('hidden');
                tambonSelect.value = 'ALL';
            }
            calculateResults();
        }

        async function loadInitialData() {
            const { data: cData } = await db.from('candidates').select('*').order('number');
            candidates = cData || [];
            const { data: vData } = await db.from('votes').select('*');
            allVotes = vData || [];
            calculateResults();
            updateLastTime();
        }

        function subscribeRealtime() {
            db.channel('realtime-votes').on('postgres_changes', { event: '*', schema: 'public', table: 'votes' }, () => {
                loadInitialData();
            }).subscribe((status) => {
                if(status === 'SUBSCRIBED') {
                    document.getElementById('statusText').innerText = 'LIVE';
                    document.getElementById('statusText').className = 'text-xs font-bold tracking-wider text-green-400';
                    document.getElementById('statusDot').className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
                }
            });
        }

        function calculateResults() {
            const amphoeVal = document.getElementById('amphoeFilter').value;
            const tambonVal = document.getElementById('tambonFilter').value;

            let scoresMap = {};
            candidates.forEach(c => scoresMap[c.id] = 0);

            allVotes.forEach(v => {
                let include = false;
                if(amphoeVal === 'ALL') include = true;
                else if(v.amphoe === amphoeVal) {
                    if(tambonVal === 'ALL' || v.tambon === tambonVal) include = true;
                }
                if(include) scoresMap[v.candidate_id] += v.score;
            });

            const results = candidates.map(c => ({...c, totalScore: scoresMap[c.id]}));
            updateChart(results);
            updateLeaderboard(results);
        }

        function updateLastTime() {
            const now = new Date();
            document.getElementById('lastUpdate').innerText = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${now.toLocaleTimeString('th-TH')}`;
        }

        function updateChart(results) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const sorted = [...results].sort((a,b) => a.number - b.number);
            const data = {
                labels: sorted.map(r => `‡πÄ‡∏ö‡∏≠‡∏£‡πå ${r.number}`),
                datasets: [{ data: sorted.map(r => r.totalScore), backgroundColor: sorted.map(r => r.color), borderRadius: 6 }]
            };
            if(myChart) { myChart.data = data; myChart.update(); }
            else myChart = new Chart(ctx, { type: 'bar', data: data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } } });
        }

        function updateLeaderboard(results) {
            const sorted = [...results].sort((a,b) => b.totalScore - a.totalScore);
            const html = sorted.map((r, i) => {
                const imgDisplay = r.photo_url 
                    ? `<img src="${r.photo_url}" class="w-12 h-12 rounded-full object-cover border-2 shadow-sm bg-white" style="border-color: ${r.color}">`
                    : `<div class="w-12 h-12 flex items-center justify-center text-white font-bold rounded-full shadow-sm" style="background-color: ${r.color}">${r.number}</div>`;

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° onclick ‡∏ó‡∏µ‡πà div ‡∏´‡∏•‡∏±‡∏Å
                return `
                <div onclick="openModal(${r.id})" class="flex items-center p-3 bg-slate-700/50 rounded-lg border-l-4 transition hover:bg-slate-700 mb-2 cursor-pointer group" style="border-color: ${r.color}">
                    <div class="font-bold text-xl text-gray-500 w-8 text-center mr-2">#${i+1}</div>
                    <div class="mr-3 relative">
                        ${imgDisplay}
                        <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-white text-slate-900 text-[10px] font-bold flex items-center justify-center rounded-full border border-slate-300">${r.number}</div>
                    </div>
                    <div class="flex-1 pl-1">
                        <div class="text-xs text-gray-400 group-hover:text-yellow-300 transition">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                        <div class="font-bold text-base text-gray-100">${r.name}</div>
                    </div>
                    <div class="text-right"><div class="text-xl font-bold text-yellow-400 font-mono highlight-update tracking-tighter">${r.totalScore.toLocaleString()}</div></div>
                </div>`
            }).join('');
            document.getElementById('leaderboard').innerHTML = html;
        }

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Modal Details ---
        function openModal(candidateId) {
            const candidate = candidates.find(c => c.id === candidateId);
            if(!candidate) return;

            // 1. ‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
            const imgDisplay = candidate.photo_url 
                ? `<img src="${candidate.photo_url}" class="w-16 h-16 rounded-full object-cover border-4 shadow-md bg-white" style="border-color: ${candidate.color}">`
                : `<div class="w-16 h-16 flex items-center justify-center text-white text-2xl font-bold rounded-full shadow-md" style="background-color: ${candidate.color}">${candidate.number}</div>`;
            
            document.getElementById('modalHeader').innerHTML = `
                ${imgDisplay}
                <div>
                    <div class="text-sm text-gray-400">‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå ${candidate.number}</div>
                    <div class="text-xl font-bold text-white">${candidate.name}</div>
                </div>
            `;

            // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
            const amphoeScores = { "‡∏≠.‡∏†‡∏π‡∏ú‡∏≤‡∏°‡πà‡∏≤‡∏ô": 0, "‡∏≠.‡∏ä‡∏∏‡∏°‡πÅ‡∏û": 0, "‡∏≠.‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π": 0 };
            let total = 0;

            allVotes.forEach(v => {
                if(v.candidate_id === candidateId) {
                    if(amphoeScores[v.amphoe] !== undefined) {
                        amphoeScores[v.amphoe] += v.score;
                    }
                    total += v.score;
                }
            });

            document.getElementById('modalTotalScore').innerText = total.toLocaleString();

            // ‡∏´‡∏≤‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î
            let maxScore = -1;
            let topAmphoe = "-";
            for(const [amp, score] of Object.entries(amphoeScores)) {
                if(score > maxScore) {
                    maxScore = score;
                    topAmphoe = amp;
                }
            }
            document.getElementById('modalTopAmphoe').innerText = topAmphoe;

            // 3. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏ô Modal
            const ctx = document.getElementById('detailChart').getContext('2d');
            if(detailChart) detailChart.destroy(); // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠

            detailChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(amphoeScores),
                    datasets: [{
                        label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
                        data: Object.values(amphoeScores),
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)', // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤
                            'rgba(255, 206, 86, 0.7)', // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
                            'rgba(255, 99, 132, 0.7)'  // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#334155' } } }
                }
            });

            // 4. ‡πÅ‡∏™‡∏î‡∏á Modal
            const modal = document.getElementById('detailModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function closeModal() {
            const modal = document.getElementById('detailModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
        }
    </script>
</body>
</html>
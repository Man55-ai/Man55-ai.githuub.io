<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Result - ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô ‡πÄ‡∏Ç‡∏ï 6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        
        /* Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ */
        .score-change { animation: highlight 1.5s ease-out; }
        @keyframes highlight {
            0% { color: #facc15; transform: scale(1.2); text-shadow: 0 0 10px rgba(250, 204, 21, 0.5); }
            100% { color: inherit; transform: scale(1); text-shadow: none; }
        }

        /* Modal Animation */
        .modal { transition: opacity 0.3s ease; }
        .modal-active { overflow: hidden; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">
    
    <div class="bg-slate-800 p-4 shadow-xl border-b border-slate-700 sticky top-0 z-20">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                <h1 class="text-xl md:text-3xl font-bold text-yellow-400 drop-shadow-md">üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á (‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô ‡πÄ‡∏Ç‡∏ï 6)</h1>
            </div>
            <div class="flex items-center space-x-2 bg-slate-900/50 px-4 py-1.5 rounded-full border border-slate-600">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-xs font-bold tracking-wider text-green-400">REALTIME</span>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-6 max-w-6xl">
        <div class="bg-slate-800/80 backdrop-blur rounded-2xl p-4 mb-8 border border-slate-700 shadow-lg">
            <div class="flex flex-col md:flex-row gap-3 items-center">
                <span class="text-slate-400 text-sm font-bold uppercase tracking-wider">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•:</span>
                <select id="amphoeFilter" class="bg-slate-700 text-white p-2.5 rounded-lg w-full md:w-auto flex-1 border border-slate-600 focus:ring-2 focus:ring-yellow-500 outline-none transition" onchange="handleAmphoeChange()"></select>
                <select id="tambonFilter" class="hidden bg-slate-700 text-white p-2.5 rounded-lg w-full md:w-auto flex-1 border border-slate-600 focus:ring-2 focus:ring-yellow-500 outline-none transition" onchange="calculateResults()">
                    <option value="ALL">‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>
                </select>
            </div>
        </div>

        <div class="bg-slate-800 rounded-3xl shadow-2xl p-6 mb-8 border border-slate-700">
            <h2 class="text-xl font-bold mb-6 text-center text-slate-200">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</h2>
            <div class="h-[350px] md:h-[450px] relative w-full">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-6">
            <div class="bg-slate-800 rounded-3xl shadow-2xl p-6 border border-slate-700">
                <div class="flex justify-between items-end mb-6 border-b border-slate-700 pb-4">
                    <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                        üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
                    </h2>
                    <span class="text-xs text-slate-500" id="lastUpdate">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
                </div>
                
                <div id="leaderboard" class="space-y-4">
                    <div class="text-center py-20 text-slate-500 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal opacity-0 pointer-events-none fixed inset-0 flex items-center justify-center z-50 px-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="bg-slate-800 w-full max-w-2xl rounded-2xl shadow-2xl z-50 transform transition-all scale-95 border border-slate-600 overflow-hidden" id="modalContainer">
            <div class="p-6">
                <div class="flex justify-between items-start mb-6">
                    <div class="flex items-center gap-4" id="modalHeader"></div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-white transition bg-slate-700 p-2 rounded-full">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <div class="h-64 relative w-full mb-6 bg-slate-900/50 rounded-xl p-4">
                    <canvas id="detailChart"></canvas>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-700/50 p-4 rounded-xl text-center border border-slate-600">
                        <span class="text-slate-400 text-xs uppercase font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</span>
                        <div class="text-3xl font-bold text-yellow-400 mt-1" id="modalTotalScore">0</div>
                    </div>
                    <div class="bg-slate-700/50 p-4 rounded-xl text-center border border-slate-600">
                        <span class="text-slate-400 text-xs uppercase font-bold">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ê‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á</span>
                        <div class="text-xl font-bold text-white mt-1 truncate px-2" id="modalTopAmphoe">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const supabaseUrl = 'https://vtxkopsgdmxygdoqdjzz.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0eGtvcHNnZG14eWdkb3Fkanp6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTA2NjYsImV4cCI6MjA4Mzg4NjY2Nn0.EabcmBvfAMLQLOt09GC_xxprZtLCJ-frsnfCf3__x5g'
        const db = window.supabase.createClient(supabaseUrl, supabaseKey)

        // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Plugin ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        Chart.register(ChartDataLabels);

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
        const realLocationData = {
            "‡∏≠.‡∏†‡∏π‡∏ú‡∏≤‡∏°‡πà‡∏≤‡∏ô": { "‡∏ï.‡∏†‡∏π‡∏ú‡∏≤‡∏°‡πà‡∏≤‡∏ô": [], "‡∏ï.‡πÇ‡∏ô‡∏ô‡∏Ñ‡∏≠‡∏°": [], "‡∏ï.‡∏ß‡∏±‡∏á‡∏™‡∏ß‡∏≤‡∏ö": [], "‡∏ï.‡∏ô‡∏≤‡∏ù‡∏≤‡∏¢": [], "‡∏ï.‡∏´‡πâ‡∏ß‡∏¢‡∏°‡πà‡∏ß‡∏á": [] },
            "‡∏≠.‡∏ä‡∏∏‡∏°‡πÅ‡∏û": { "‡∏ï.‡∏ä‡∏∏‡∏°‡πÅ‡∏û (‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á)": [], "‡∏ï.‡∏ä‡∏∏‡∏°‡πÅ‡∏û (‡∏≠‡∏ö‡∏ï.)": [], "‡∏ï.‡∏Ç‡∏±‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏á": [], "‡∏ï.‡∏ô‡∏≤‡∏´‡∏ô‡∏≠‡∏á‡∏ó‡∏∏‡πà‡∏°": [], "‡∏ï.‡πÇ‡∏ô‡∏ô‡∏´‡∏±‡∏ô": [], "‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏î": [], "‡∏ï.‡πÇ‡∏ô‡∏ô‡∏™‡∏∞‡∏≠‡∏≤‡∏î": [], "‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡πÄ‡∏™‡∏≤‡πÄ‡∏•‡πâ‡∏≤": [], "‡∏ï.‡πÇ‡∏ô‡∏ô‡∏≠‡∏∏‡∏î‡∏°": [], "‡∏ï.‡∏ß‡∏±‡∏á‡∏´‡∏¥‡∏ô‡∏•‡∏≤‡∏î": [], "‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡πÑ‡∏ú‡πà": [], "‡∏ï.‡∏ô‡∏≤‡πÄ‡∏û‡∏µ‡∏¢‡∏á": [], "‡∏ï.‡πÑ‡∏ä‡∏¢‡∏™‡∏≠": [] },
            "‡∏≠.‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π": { "‡∏ï.‡∏ô‡∏≤‡∏à‡∏≤‡∏ô": [], "‡∏ï.‡∏ã‡∏≥‡∏¢‡∏≤‡∏á": [] }
        };

        let candidates = [], allVotes = [], myChart = null, detailChart = null;

        // --- INIT ---
        window.onload = async () => {
            initFilters();
            await loadInitialData();
            subscribeRealtime();
        };

        function initFilters() {
            const select = document.getElementById('amphoeFilter');
            select.innerHTML = `<option value="ALL">üìç ‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>`;
            Object.keys(realLocationData).forEach(a => select.innerHTML += `<option value="${a}">‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ${a}</option>`);
        }

        function handleAmphoeChange() {
            const amphoe = document.getElementById('amphoeFilter').value;
            const tambonSelect = document.getElementById('tambonFilter');
            if(amphoe === 'ALL') {
                tambonSelect.classList.add('hidden'); tambonSelect.value = 'ALL';
            } else {
                tambonSelect.innerHTML = `<option value="ALL">‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏•‡πÉ‡∏ô ${amphoe}</option>`;
                Object.keys(realLocationData[amphoe]).forEach(t => tambonSelect.innerHTML += `<option value="${t}">${t}</option>`);
                tambonSelect.classList.remove('hidden'); tambonSelect.value = 'ALL';
            }
            calculateResults();
        }

        // --- DATA LOADING ---
        async function loadInitialData() {
            const { data: cData } = await db.from('candidates').select('*').order('number');
            candidates = cData || [];
            const { data: vData } = await db.from('votes').select('*');
            allVotes = vData || [];
            calculateResults();
            updateLastTime();
        }

        function subscribeRealtime() {
            db.channel('public:votes').on('postgres_changes', { event: '*', schema: 'public', table: 'votes' }, (payload) => {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Array votes ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
                if(payload.eventType === 'INSERT') allVotes.push(payload.new);
                if(payload.eventType === 'UPDATE') {
                    const idx = allVotes.findIndex(v => v.id === payload.new.id);
                    if(idx > -1) allVotes[idx] = payload.new;
                }
                calculateResults(); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà
                updateLastTime();
            }).subscribe();
        }

        function calculateResults() {
            const amphoeVal = document.getElementById('amphoeFilter').value;
            const tambonVal = document.getElementById('tambonFilter').value;

            let scoresMap = {};
            candidates.forEach(c => scoresMap[c.id] = 0);

            allVotes.forEach(v => {
                let include = false;
                if(amphoeVal === 'ALL') include = true;
                else if(v.amphoe === amphoeVal) {
                    if(tambonVal === 'ALL' || v.tambon === tambonVal) include = true;
                }
                if(include) scoresMap[v.candidate_id] += v.score;
            });

            const results = candidates.map(c => ({...c, totalScore: scoresMap[c.id]}));
            updateChart(results);
            updateLeaderboard(results);
        }

        function updateLastTime() {
            const now = new Date();
            document.getElementById('lastUpdate').innerText = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${now.toLocaleTimeString('th-TH')}`;
        }

        // --- GRAPH LOGIC (SMOOTH UPDATE) ---
        function updateChart(results) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏°‡πà‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏õ‡∏°‡∏≤ (‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß)
            const sortedByNumber = [...results].sort((a,b) => a.number - b.number);
            
            const labels = sortedByNumber.map(r => `‡πÄ‡∏ö‡∏≠‡∏£‡πå ${r.number}`);
            const dataValues = sortedByNumber.map(r => r.totalScore);
            const colors = sortedByNumber.map(r => r.color);

            if (myChart) {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Smooth Animation)
                myChart.data.datasets[0].data = dataValues;
                myChart.update(); 
            } else {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: dataValues,
                            backgroundColor: colors,
                            borderRadius: 8,
                            borderSkipped: false,
                            barPercentage: 0.7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { top: 30 } }, // ‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                        plugins: {
                            legend: { display: false },
                            datalabels: { // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
                                anchor: 'end',
                                align: 'top',
                                color: '#ffffff',
                                font: { weight: 'bold', size: 16, family: 'Sarabun' },
                                formatter: (value) => value.toLocaleString(), // ‡πÉ‡∏™‡πà‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥
                                offset: 4
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true, 
                                grid: { color: '#334155' },
                                ticks: { color: '#94a3b8', font: {family: 'Sarabun'} } 
                            },
                            x: { 
                                grid: { display: false },
                                ticks: { color: '#cbd5e1', font: {size: 14, weight:'bold', family: 'Sarabun'} }
                            }
                        },
                        animation: {
                            duration: 800, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß Animation
                            easing: 'easeOutQuart'
                        }
                    }
                });
            }
        }

        // --- LEADERBOARD (BIG UI) ---
        function updateLeaderboard(results) {
            const sorted = [...results].sort((a,b) => b.totalScore - a.totalScore);
            
            const html = sorted.map((r, i) => {
                // ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô (w-20 h-20 = 80px)
                const imgDisplay = r.photo_url 
                    ? `<img src="${r.photo_url}" class="w-20 h-20 rounded-full object-cover border-4 shadow-md bg-white" style="border-color: ${r.color}">`
                    : `<div class="w-20 h-20 flex items-center justify-center text-white text-3xl font-bold rounded-full shadow-md" style="background-color: ${r.color}">${r.number}</div>`;

                return `
                <div onclick="openModal(${r.id})" class="flex items-center p-4 bg-slate-700/40 rounded-2xl border-l-8 transition hover:bg-slate-700 cursor-pointer group mb-3 relative overflow-hidden" style="border-color: ${r.color}">
                    
                    <div class="font-bold text-3xl text-slate-600 w-12 text-center mr-4 italic">#${i+1}</div>
                    
                    <div class="mr-5 relative">
                        ${imgDisplay}
                        <div class="absolute -bottom-1 -right-1 w-8 h-8 bg-white text-slate-900 text-sm font-bold flex items-center justify-center rounded-full border-2 border-slate-300 shadow-sm">
                            ${r.number}
                        </div>
                    </div>

                    <div class="flex-1 pr-4">
                        <div class="text-xs text-slate-400 mb-1 group-hover:text-yellow-400 transition">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                        <div class="font-bold text-xl md:text-2xl text-white leading-tight">${r.name}</div>
                    </div>

                    <div class="text-right">
                        <div class="text-3xl md:text-4xl font-bold text-yellow-400 font-mono tracking-tighter score-change drop-shadow-sm">
                            ${r.totalScore.toLocaleString()}
                        </div>
                        <div class="text-xs text-slate-400 font-bold mt-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                    </div>
                </div>`
            }).join('');
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏´‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏Ç‡∏≠‡∏á DOM (Simple Diff)
            const currentHTML = document.getElementById('leaderboard').innerHTML;
            if(currentHTML.length < 100 || Math.abs(currentHTML.length - html.length) > 0) {
                 document.getElementById('leaderboard').innerHTML = html;
            }
        }

        // --- MODAL DETAILS ---
        function openModal(candidateId) {
            const candidate = candidates.find(c => c.id === candidateId);
            if(!candidate) return;

            const imgDisplay = candidate.photo_url 
                ? `<img src="${candidate.photo_url}" class="w-24 h-24 rounded-full object-cover border-4 shadow-lg bg-white" style="border-color: ${candidate.color}">`
                : `<div class="w-24 h-24 flex items-center justify-center text-white text-4xl font-bold rounded-full shadow-lg" style="background-color: ${candidate.color}">${candidate.number}</div>`;
            
            document.getElementById('modalHeader').innerHTML = `
                ${imgDisplay}
                <div>
                    <div class="text-sm text-slate-400 font-bold uppercase tracking-wide">‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå ${candidate.number}</div>
                    <div class="text-2xl font-bold text-white leading-tight mt-1">${candidate.name}</div>
                </div>
            `;

            const amphoeScores = { "‡∏≠.‡∏†‡∏π‡∏ú‡∏≤‡∏°‡πà‡∏≤‡∏ô": 0, "‡∏≠.‡∏ä‡∏∏‡∏°‡πÅ‡∏û": 0, "‡∏≠.‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π": 0 };
            let total = 0;
            allVotes.forEach(v => {
                if(v.candidate_id === candidateId) {
                    if(amphoeScores[v.amphoe] !== undefined) amphoeScores[v.amphoe] += v.score;
                    total += v.score;
                }
            });

            document.getElementById('modalTotalScore').innerText = total.toLocaleString();
            let maxScore = -1, topAmphoe = "-";
            for(const [amp, score] of Object.entries(amphoeScores)) {
                if(score > maxScore) { maxScore = score; topAmphoe = amp; }
            }
            document.getElementById('modalTopAmphoe').innerText = topAmphoe;

            const ctx = document.getElementById('detailChart').getContext('2d');
            if(detailChart) detailChart.destroy();

            detailChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(amphoeScores),
                    datasets: [{
                        label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',
                        data: Object.values(amphoeScores),
                        backgroundColor: [ '#3b82f6', '#eab308', '#ef4444' ],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, datalabels: { color: '#fff', anchor:'end', align:'top', font:{weight:'bold'} } },
                    scales: { 
                        y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#cbd5e1' } }
                    }
                }
            });

            const modal = document.getElementById('detailModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('modalContainer').classList.remove('scale-95');
            document.getElementById('modalContainer').classList.add('scale-100');
            document.body.classList.add('modal-active');
        }

        function closeModal() {
            const modal = document.getElementById('detailModal');
            document.getElementById('modalContainer').classList.remove('scale-100');
            document.getElementById('modalContainer').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
            }, 100);
        }
    </script>
</body>
</html>